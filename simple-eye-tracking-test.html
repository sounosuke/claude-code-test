<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¨ç·Šæ€¥ãƒ†ã‚¹ãƒˆ: ã‚·ãƒ³ãƒ—ãƒ«çœ¼çƒè¿½è·¡ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #00ff00;
        }
        .error-section {
            border-left: 4px solid #ff0000;
        }
        .status {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        button {
            background: linear-gradient(45deg, #00ff00, #0080ff);
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
        }
        .log {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            border: 1px solid #333;
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #4488ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ ç·Šæ€¥ãƒ†ã‚¹ãƒˆ: ã‚·ãƒ³ãƒ—ãƒ«çœ¼çƒè¿½è·¡ã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <div class="test-section">
            <h2>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h2>
            <div class="status" id="system-status">åˆæœŸåŒ–ä¸­...</div>
            <div class="status" id="webgazer-status">WebGazer.js: ç¢ºèªä¸­</div>
            <div class="status" id="camera-status">ã‚«ãƒ¡ãƒ©: æœªç¢ºèª</div>
            <div class="status" id="browser-status">ãƒ–ãƒ©ã‚¦ã‚¶: ç¢ºèªä¸­</div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ çœ¼çƒè¿½è·¡ãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testWebGazerBasic()">åŸºæœ¬ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button onclick="testCameraAccess()">ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="startSimpleCalibration()">ã‚·ãƒ³ãƒ—ãƒ«æ ¡æ­£é–‹å§‹</button>
            <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“ è©³ç´°ãƒ­ã‚°</h2>
            <div class="log" id="detailed-log">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...\n</div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ ç’°å¢ƒæƒ…å ±</h2>
            <div class="status" id="env-info">åé›†ä¸­...</div>
        </div>
    </div>

    <!-- WebGazer.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/webgazer@2.0.1/dist/webgazer.min.js"></script>

    <script>
        // ğŸš¨ ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿéš›ãƒ†ã‚¹ãƒˆç”¨JavaScript
        let logElement = null;
        let webgazerReady = false;
        let calibrationActive = false;

        // ãƒ­ã‚°æ©Ÿèƒ½
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            
            console.log(`[${timestamp}] ${message}`);
            
            if (!logElement) {
                logElement = document.getElementById('detailed-log');
            }
            
            const logLine = document.createElement('div');
            logLine.className = colorClass;
            logLine.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logLine);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLogs() {
            if (logElement) {
                logElement.innerHTML = '';
            }
            console.clear();
            log('ãƒ­ã‚°ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        async function initializeSystem() {
            log('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹', 'info');
            
            // ç’°å¢ƒæƒ…å ±åé›†
            collectEnvironmentInfo();
            
            // WebGazer.jsç¢ºèª
            checkWebGazerAvailability();
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª
            checkBrowserSupport();
        }

        function collectEnvironmentInfo() {
            try {
                const info = {
                    userAgent: navigator.userAgent,
                    protocol: window.location.protocol,
                    hostname: window.location.hostname,
                    hasMediaDevices: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                    hasWebGL: !!window.WebGLRenderingContext,
                    cookieEnabled: navigator.cookieEnabled,
                    language: navigator.language
                };
                
                document.getElementById('env-info').innerHTML = `
                    <strong>ãƒ–ãƒ©ã‚¦ã‚¶:</strong> ${getBrowserName()}<br>
                    <strong>ãƒ—ãƒ­ãƒˆã‚³ãƒ«:</strong> ${info.protocol}<br>
                    <strong>ãƒ›ã‚¹ãƒˆ:</strong> ${info.hostname}<br>
                    <strong>MediaDevices:</strong> ${info.hasMediaDevices ? 'âœ…' : 'âŒ'}<br>
                    <strong>WebGL:</strong> ${info.hasWebGL ? 'âœ…' : 'âŒ'}<br>
                    <strong>è¨€èª:</strong> ${info.language}
                `;
                
                log(`ç’°å¢ƒæƒ…å ±åé›†å®Œäº†: ${getBrowserName()} on ${info.protocol}//${info.hostname}`, 'success');
            } catch (error) {
                log(`ç’°å¢ƒæƒ…å ±åé›†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function getBrowserName() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome') && !ua.includes('Edge')) return 'Chrome';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            return 'Unknown';
        }

        function checkWebGazerAvailability() {
            if (typeof webgazer !== 'undefined') {
                log('âœ… WebGazer.jsåˆ©ç”¨å¯èƒ½', 'success');
                document.getElementById('webgazer-status').textContent = 'WebGazer.js: âœ… åˆ©ç”¨å¯èƒ½';
                webgazerReady = true;
            } else {
                log('âŒ WebGazer.jsãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                document.getElementById('webgazer-status').textContent = 'WebGazer.js: âŒ åˆ©ç”¨ä¸å¯';
                webgazerReady = false;
            }
        }

        function checkBrowserSupport() {
            const issues = [];
            
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                issues.push('HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™');
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                issues.push('ã‚«ãƒ¡ãƒ©APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            if (!window.WebGLRenderingContext) {
                issues.push('WebGLãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            if (issues.length === 0) {
                log('âœ… ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèªå®Œäº†', 'success');
                document.getElementById('browser-status').textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶: âœ… å¯¾å¿œ';
            } else {
                log(`âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆå•é¡Œ: ${issues.join(', ')}`, 'warning');
                document.getElementById('browser-status').textContent = `ãƒ–ãƒ©ã‚¦ã‚¶: âš ï¸ ${issues.length}å€‹ã®å•é¡Œ`;
            }
        }

        // åŸºæœ¬ãƒ†ã‚¹ãƒˆ
        async function testWebGazerBasic() {
            log('ğŸ§ª WebGazeråŸºæœ¬ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                if (!webgazerReady) {
                    throw new Error('WebGazer.jsãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                log('WebGazeråˆæœŸåŒ–ä¸­...', 'info');
                
                // åŸºæœ¬çš„ãªåˆæœŸåŒ–ã®ã¿
                await webgazer.setGazeListener(function(data, clock) {
                    if (data) {
                        log(`è¦–ç·šãƒ‡ãƒ¼ã‚¿: x=${Math.round(data.x)}, y=${Math.round(data.y)}`, 'info');
                    }
                }).begin();
                
                log('âœ… WebGazeråŸºæœ¬åˆæœŸåŒ–æˆåŠŸ', 'success');
                document.getElementById('system-status').textContent = 'ã‚·ã‚¹ãƒ†ãƒ : âœ… åˆæœŸåŒ–å®Œäº†';
                
                // åŸºæœ¬è¨­å®š
                webgazer.showVideoPreview(false);
                webgazer.showPredictionPoints(false);
                
                log('åŸºæœ¬è¨­å®šé©ç”¨å®Œäº†', 'success');
                
            } catch (error) {
                log(`âŒ WebGazeråŸºæœ¬ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                document.getElementById('system-status').textContent = `ã‚·ã‚¹ãƒ†ãƒ : âŒ ${error.message}`;
            }
        }

        // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
        async function testCameraAccess() {
            log('ğŸ“· ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                
                log('âœ… ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ', 'success');
                document.getElementById('camera-status').textContent = 'ã‚«ãƒ¡ãƒ©: âœ… ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½';
                
                // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                stream.getTracks().forEach(track => track.stop());
                log('ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢', 'info');
                
            } catch (error) {
                log(`âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ${error.message}`, 'error');
                document.getElementById('camera-status').textContent = `ã‚«ãƒ¡ãƒ©: âŒ ${error.message}`;
                
                // å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼åŸå› ã®åˆ†æ
                if (error.name === 'NotAllowedError') {
                    log('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'warning');
                } else if (error.name === 'NotFoundError') {
                    log('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'warning');
                } else if (error.name === 'NotSupportedError') {
                    log('HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚', 'warning');
                }
            }
        }

        // ã‚·ãƒ³ãƒ—ãƒ«æ ¡æ­£
        async function startSimpleCalibration() {
            log('ğŸ¯ ã‚·ãƒ³ãƒ—ãƒ«æ ¡æ­£é–‹å§‹', 'info');
            
            if (!webgazerReady) {
                log('WebGazer.jsãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            if (calibrationActive) {
                log('æ—¢ã«æ ¡æ­£ãŒå®Ÿè¡Œä¸­ã§ã™', 'warning');
                return;
            }
            
            try {
                calibrationActive = true;
                
                // ã¾ãšWebGazeråˆæœŸåŒ–
                await testWebGazerBasic();
                
                log('æ ¡æ­£ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™', 'info');
                showSimpleCalibrationInterface();
                
            } catch (error) {
                log(`æ ¡æ­£é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                calibrationActive = false;
            }
        }

        function showSimpleCalibrationInterface() {
            const overlay = document.createElement('div');
            overlay.id = 'calibration-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                color: white;
                font-family: Arial, sans-serif;
            `;
            
            overlay.innerHTML = `
                <div style="text-align: center;">
                    <h2>ğŸ¯ ã‚·ãƒ³ãƒ—ãƒ«æ ¡æ­£ãƒ†ã‚¹ãƒˆ</h2>
                    <p>ã“ã®èµ¤ã„ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                    <div style="
                        width: 30px;
                        height: 30px;
                        background: red;
                        border-radius: 50%;
                        margin: 30px auto;
                        cursor: pointer;
                        animation: pulse 1s infinite;
                    " onclick="completeSimpleCalibration()"></div>
                    <button onclick="cancelCalibration()" style="
                        background: #ff4444;
                        border: none;
                        padding: 10px 20px;
                        color: white;
                        border-radius: 5px;
                        cursor: pointer;
                    ">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;
            
            // CSS ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
            if (!document.getElementById('calibration-style')) {
                const style = document.createElement('style');
                style.id = 'calibration-style';
                style.textContent = `
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.2); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(overlay);
            log('æ ¡æ­£ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¡¨ç¤ºå®Œäº†', 'success');
        }

        function completeSimpleCalibration() {
            log('ğŸ‰ ã‚·ãƒ³ãƒ—ãƒ«æ ¡æ­£å®Œäº†', 'success');
            
            try {
                // WebGazeræ ¡æ­£ã‚’å®Ÿè¡Œ
                webgazer.recordScreenPosition(window.innerWidth/2, window.innerHeight/2, 'click');
                log('WebGazeræ ¡æ­£ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²å®Œäº†', 'success');
            } catch (error) {
                log(`æ ¡æ­£ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
            
            const overlay = document.getElementById('calibration-overlay');
            if (overlay) {
                overlay.remove();
            }
            
            calibrationActive = false;
            log('æ ¡æ­£ãƒ—ãƒ­ã‚»ã‚¹å®Œäº†', 'success');
        }

        function cancelCalibration() {
            log('æ ¡æ­£ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'warning');
            const overlay = document.getElementById('calibration-overlay');
            if (overlay) {
                overlay.remove();
            }
            calibrationActive = false;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã®åˆæœŸåŒ–
        window.addEventListener('load', function() {
            log('ğŸ“„ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'info');
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
            setTimeout(initializeSystem, 500);
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(event) {
            log(`ğŸ’¥ JavaScript ã‚¨ãƒ©ãƒ¼: ${event.error.message}`, 'error');
        });

        // WebGazer.jsèª­ã¿è¾¼ã¿å®Œäº†æ™‚
        if (typeof webgazer !== 'undefined') {
            log('WebGazer.jsèª­ã¿è¾¼ã¿æ¤œå‡º', 'success');
        } else {
            log('WebGazer.jsèª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...', 'info');
        }
    </script>
</body>
</html>